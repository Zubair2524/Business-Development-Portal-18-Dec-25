<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shaigan Pharma - BD Database</title>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --primary-blue: #1976d2;
            --accent-green: #43a047;
            --text-main: #e3f2fd;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(180deg, #0a1929 0%, #1a2332 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            color: var(--text-main);
        }

        .container { max-width: 1600px; margin: 0 auto; }

        /* Header */
        .header { text-align: center; margin-bottom: 30px; }
        .feature-badge { background: linear-gradient(135deg, var(--accent-green), #66bb6a); color: white; padding: 6px 15px; border-radius: 20px; font-size: 0.85em; font-weight: 700; margin: 5px; display: inline-block; }

        /* Search & Filters */
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; margin-bottom: 25px; }
        .search-row { display: flex; gap: 15px; flex-wrap: wrap; }
        .search-input { flex: 2; min-width: 300px; padding: 15px; border-radius: 12px; border: none; font-size: 1em; }
        .filter-select { flex: 1; padding: 15px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white; font-weight: 600; cursor: pointer; }
        .filter-select option { background: #1a2332; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: rgba(25, 118, 210, 0.1); border: 1px solid rgba(100, 181, 246, 0.2); border-radius: 16px; padding: 15px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: 800; display: block; }
        .stat-label { font-size: 0.7em; text-transform: uppercase; color: #b0bec5; }

        /* Results */
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px; }
        .product-card { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 18px; padding: 20px; transition: 0.3s; position: relative; }
        .product-card:hover { transform: translateY(-5px); border-color: var(--primary-blue); }
        
        .product-name { font-size: 1.2em; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-bottom: 10px; }
        .info-label { font-size: 0.65em; color: #90caf9; text-transform: uppercase; margin-top: 10px; font-weight: 800; }
        .info-value { font-size: 0.9em; margin-bottom: 5px; }
        
        .badge-row { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 15px; }
        .badge { padding: 4px 10px; border-radius: 5px; font-size: 0.7em; font-weight: 800; background: rgba(25, 118, 210, 0.2); border: 1px solid rgba(25, 118, 210, 0.3); }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; text-decoration: none; text-align: center; font-size: 0.85em; }
        .btn-edit { background: var(--primary-blue); color: white; }
        .btn-google { background: #4285f4; color: white; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto; }
        .modal.show { display: flex; }
        .modal-content { background: #1e3a5f; padding: 30px; border-radius: 20px; width: 90%; max-width: 700px; margin: 20px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-row { margin-bottom: 15px; }
        .form-row.full { grid-column: span 2; }
        .form-row label { display: block; margin-bottom: 5px; color: #90caf9; font-size: 0.75em; font-weight: 700; }
        .form-row input, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #333; background: #0a1929; color: white; }
        .save-btn { width: 100%; padding: 15px; background: var(--accent-green); color: white; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üß¨ Shaigan Pharma BD Portal</h1>
        <div class="feature-badges">
            <span class="feature-badge">DATABASE ACTIVE</span>
            <span class="feature-badge">RECORDS: <span id="syncTotal">0</span></span>
        </div>
    </div>

    <div class="glass-card">
        <div class="search-row">
            <input type="text" id="mainSearch" class="search-input" placeholder="Search product, composition, indication...">
            <select id="filterTeam" class="filter-select"><option value="">All Teams</option></select>
            <select id="filterForm" class="filter-select"><option value="">All Forms</option></select>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><span class="stat-number" id="statFiltered">0</span><span class="stat-label">Matching Products</span></div>
        <div class="stat-card"><span class="stat-number" id="statGrowth">0%</span><span class="stat-label">Avg Value Growth</span></div>
    </div>

    <div id="productGrid" class="results-grid"><div style="text-align:center; padding: 50px; width:100%;">üì° Syncing with Cloud...</div></div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-bottom:20px;">Update Product Record</h2>
        <div class="form-grid">
            <div class="form-row"><label>Product Name</label><input type="text" id="mName" readonly></div>
            <div class="form-row"><label>Composition</label><input type="text" id="mComp"></div>
            <div class="form-row"><label>Team</label><input type="text" id="mTeam"></div>
            <div class="form-row"><label>Dosage Form</label><input type="text" id="mForm"></div>
            <div class="form-row"><label>MAT Value</label><input type="text" id="mMAT"></div>
            <div class="form-row"><label>Value Growth (%)</label><input type="text" id="mGrowth"></div>
            <div class="form-row"><label>Unit Sale</label><input type="text" id="mUnit"></div>
            <div class="form-row"><label>Registration Status</label><input type="text" id="mReg"></div>
            <div class="form-row full"><label>Indication</label><textarea id="mInd" rows="2"></textarea></div>
            <div class="form-row full"><label>Special Note</label><textarea id="mNote" rows="2"></textarea></div>
        </div>
        <button class="save-btn" onclick="submitData()">Save Changes to Cloud</button>
        <button onclick="closeModal()" style="width:100%; background:none; color:white; border:none; margin-top:10px; cursor:pointer;">Cancel</button>
    </div>
</div>

<script>
    // 1. UPDATE THIS URL WITH YOUR NEW DEPLOYMENT URL
    const API_URL = "https://script.google.com/macros/s/AKfycbwm2u27sZNPQqyS5CV_-T3vYHrm0mC2du22Zk68sKKtozp-FLFFzXZKBItDxrPzwZdYiQ/exec";
    
    let dbRaw = [];
    let dbFiltered = [];

    async function init() {
        try {
            const response = await fetch(API_URL);
            dbRaw = await response.json();
            dbFiltered = [...dbRaw];
            populateFilters();
            render();
        } catch (e) {
            document.getElementById('productGrid').innerHTML = `<div style="color:red; text-align:center;">‚ö†Ô∏è Connection Error: Please ensure Web App is deployed as 'Anyone'.</div>`;
        }
    }

    function populateFilters() {
        const teams = [...new Set(dbRaw.map(x => x.TeamName).filter(Boolean))].sort();
        const forms = [...new Set(dbRaw.map(x => x.DosageForm).filter(Boolean))].sort();
        const tSel = document.getElementById('filterTeam');
        const fSel = document.getElementById('filterForm');
        teams.forEach(t => tSel.innerHTML += `<option value="${t}">${t}</option>`);
        forms.forEach(f => fSel.innerHTML += `<option value="${f}">${f}</option>`);
    }

    function render() {
        const grid = document.getElementById('productGrid');
        document.getElementById('syncTotal').innerText = dbRaw.length;
        document.getElementById('statFiltered').innerText = dbFiltered.length;

        grid.innerHTML = dbFiltered.slice(0, 40).map(p => `
            <div class="product-card">
                <div class="product-name">${p.ProductName}</div>
                <div class="info-label">Composition</div>
                <div class="info-value">${p.Composition}</div>
                <div class="info-label">MAT Value / Growth</div>
                <div class="info-value" style="color:#ffc107; font-weight:bold;">${p.MATValue} (${p.ValueGrowth || '0%'})</div>
                <div class="info-label">Indication</div>
                <div class="info-value">${p.Indication || 'N/A'}</div>
                
                <div class="badge-row">
                    <span class="badge">${p.TeamName || 'General'}</span>
                    <span class="badge">${p.DosageForm || 'Form'}</span>
                    <span class="badge">${p.RegistrationStatus || 'Active'}</span>
                </div>

                <div class="btn-group">
                    <a href="https://www.google.com/search?q=${p.ProductName}+pharma" target="_blank" class="btn btn-google">Search</a>
                    <button onclick="openModal('${p.ProductName.replace(/'/g, "\\'")}')" class="btn btn-edit">Edit</button>
                </div>
            </div>
        `).join('');
    }

    function applyFilters() {
        const term = document.getElementById('mainSearch').value.toLowerCase();
        const team = document.getElementById('filterTeam').value;
        const form = document.getElementById('filterForm').value;

        dbFiltered = dbRaw.filter(p => {
            const matchSearch = p.ProductName.toLowerCase().includes(term) || p.Composition.toLowerCase().includes(term);
            const matchTeam = !team || p.TeamName === team;
            const matchForm = !form || p.DosageForm === form;
            return matchSearch && matchTeam && matchForm;
        });
        render();
    }

    function openModal(name) {
        const p = dbRaw.find(x => x.ProductName === name);
        document.getElementById('mName').value = p.ProductName;
        document.getElementById('mComp').value = p.Composition;
        document.getElementById('mTeam').value = p.TeamName;
        document.getElementById('mForm').value = p.DosageForm;
        document.getElementById('mMAT').value = p.MATValue;
        document.getElementById('mGrowth').value = p.ValueGrowth;
        document.getElementById('mUnit').value = p.UnitSale;
        document.getElementById('mReg').value = p.RegistrationStatus;
        document.getElementById('mInd').value = p.Indication;
        document.getElementById('mNote').value = p.SpecialNote;
        document.getElementById('editModal').classList.add('show');
    }

    function closeModal() { document.getElementById('editModal').classList.remove('show'); }

    async function submitData() {
        const btn = document.querySelector('.save-btn');
        btn.innerText = "Syncing...";
        const payload = {
            ProductName: document.getElementById('mName').value,
            Composition: document.getElementById('mComp').value,
            TeamName: document.getElementById('mTeam').value,
            DosageForm: document.getElementById('mForm').value,
            MATValue: document.getElementById('mMAT').value,
            ValueGrowth: document.getElementById('mGrowth').value,
            UnitSale: document.getElementById('mUnit').value,
            RegistrationStatus: document.getElementById('mReg').value,
            Indication: document.getElementById('mInd').value,
            SpecialNote: document.getElementById('mNote').value
        };

        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        alert("Update Sent! Refreshing dashboard...");
        location.reload();
    }

    document.getElementById('mainSearch').addEventListener('input', applyFilters);
    document.getElementById('filterTeam').addEventListener('change', applyFilters);
    document.getElementById('filterForm').addEventListener('change', applyFilters);
    window.onload = init;
</script>
</body>
</html>
